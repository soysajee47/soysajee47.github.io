<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JIBCHAIN Sensor Dash | Flood Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.344.0/dist/umd/lucide.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }

        .loading-shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div id="app" class="max-w-6xl mx-auto space-y-6">
        <!-- Header Section -->
        <header
            class="glass-card rounded-2xl p-6 shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
            <div>
                <h1 class="text-2xl font-bold text-slate-900" id="store-nickname">Loading...</h1>
                <p class="text-slate-500" id="store-description">Connecting to JIBCHAIN L1...</p>
                <div class="mt-2 flex items-center space-x-2 text-sm text-slate-400">
                    <span id="store-address-link" class="flex items-center hover:text-blue-500 cursor-pointer">
                        <span id="store-address-truncated">0x...</span>
                        <i data-lucide="external-link" class="w-3 h-3 ml-1"></i>
                    </span>
                    <span class="text-slate-300">|</span>
                    <span class="flex items-center text-green-600 font-medium">
                        <span class="w-2 h-2 bg-green-500 rounded-full mr-1.5 animate-pulse"></span>
                        <span id="current-block">Block: ...</span>
                    </span>
                </div>
            </div>
            <div class="text-right">
                <div class="text-sm font-medium text-slate-500">Last Updated</div>
                <div class="text-lg font-bold text-blue-600" id="last-updated-time">--:--:-- --</div>
                <div class="text-xs text-slate-400" id="last-updated-date">--/--/----</div>
            </div>
        </header>

        <!-- Main Card -->
        <main class="glass-card rounded-2xl shadow-lg flex flex-col overflow-hidden">
            <!-- Controls Overlay (Top) -->
            <div class="p-4 md:p-6 border-b border-slate-100 flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center space-x-2">
                    <button onclick="switchChart('waterDepth')" id="btn-water-depth"
                        class="px-4 py-2 rounded-lg text-sm font-semibold transition-all bg-blue-500 text-white shadow-md">
                        Water Depth
                    </button>
                    <button onclick="switchChart('batteryVoltage')" id="btn-battery-voltage"
                        class="px-4 py-2 rounded-lg text-sm font-semibold transition-all bg-slate-100 text-slate-600 hover:bg-slate-200">
                        Battery Voltage
                    </button>
                </div>
                <div class="flex items-center space-x-3">
                    <select id="store-selector" onchange="switchStore(this.value)"
                        class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                        <option value="0xCd3Ec17ddFDa24f8F97131fa0FDf20e7cbd1A8Bb">FloodBoy001</option>
                        <option value="0x0994Bc66b2863f8D58C8185b1ed6147895632812" selected>FloodBoy016</option>
                    </select>
                    <select id="group-interval"
                        class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg block p-2">
                        <option value="30">30 Min</option>
                        <option value="60">1 Hour</option>
                    </select>
                    <div class="flex space-x-1">
                        <button onclick="toggleFields()" class="p-2 text-slate-400 hover:text-slate-600"
                            title="Show/Hide Fields">
                            <i data-lucide="layers" class="w-5 h-5"></i>
                        </button>
                        <button onclick="toggleFullscreen()" class="p-2 text-slate-400 hover:text-slate-600"
                            title="Maximize">
                            <i data-lucide="maximize" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="p-6">
                <div id="chart-loading" class="chart-container rounded-xl loading-shimmer hidden"></div>
                <div id="chart-parent" class="chart-container">
                    <canvas id="sensorChart"></canvas>
                </div>
            </div>

            <!-- Table Section -->
            <div class="overflow-x-auto" id="table-container">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-slate-500 text-xs font-semibold uppercase tracking-wider">
                        <tr>
                            <th class="px-6 py-4">Metric</th>
                            <th class="px-6 py-4">Current</th>
                            <th class="px-6 py-4">Min</th>
                            <th class="px-6 py-4">Max</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="text-slate-700 divide-y divide-slate-100">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>

            <!-- Footer Section -->
            <footer class="p-6 bg-slate-50 border-t border-slate-100 grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                <div class="space-y-1">
                    <span class="text-slate-400 block uppercase text-[10px] font-bold tracking-widest">Store
                        Owner</span>
                    <a id="owner-link" href="#" target="_blank"
                        class="text-blue-600 font-medium hover:underline flex items-center">
                        <span id="owner-address">0x...</span>
                        <i data-lucide="external-link" class="w-3 h-3 ml-1"></i>
                    </a>
                </div>
                <div class="space-y-1">
                    <span class="text-slate-400 block uppercase text-[10px] font-bold tracking-widest">Deployed
                        Block</span>
                    <a id="deployed-block-link" href="#" target="_blank"
                        class="text-slate-700 font-medium hover:text-blue-600 flex items-center">
                        <span id="deployed-block-number">#...</span>
                        <i data-lucide="external-link" class="w-3 h-3 ml-1"></i>
                    </a>
                </div>
                <div class="space-y-1">
                    <span class="text-slate-400 block uppercase text-[10px] font-bold tracking-widest">Sensors</span>
                    <div class="flex items-center space-x-2">
                        <span id="sensor-count"
                            class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs font-bold">0</span>
                        <span class="text-slate-600 font-medium">Authorized Scanner</span>
                    </div>
                </div>
            </footer>
        </main>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { createPublicClient, http, parseAbi } from 'https://esm.sh/viem';

        // Configuration
        const JIBCHAIN = {
            id: 8899,
            name: 'JIBCHAIN L1',
            rpcUrls: { default: { http: ['https://rpc-l1.jibchain.net'] } },
            blockExplorers: { default: { name: 'JibExp', url: 'https://exp.jibchain.net' } }
        };

        const FACTORY_ADDRESS = '0x63bB41b79b5aAc6e98C7b35Dcb0fE941b85Ba5Bb';
        const UNIVERSAL_SIGNER = '0xcB0e58b011924e049ce4b4D62298Edf43dFF0BDd';

        const FACTORY_ABI = parseAbi([
            'function getStoreInfo(address store) view returns (string nickname, address owner, uint256 authorizedSensorCount, uint128 deployedBlock, string description)'
        ]);

        const STORE_ABI = parseAbi([
            'function getAllFields() view returns ((string name, string unit, string dtype)[])',
            'function getLatestRecord(address sensor) view returns (uint256 timestamp, int256[] values)',
            'event RecordStored(address indexed sensor, uint256 timestamp, int256[] values)'
        ]);

        const client = createPublicClient({ chain: JIBCHAIN, transport: http() });

        // State Management
        let currentStore = '0x0994Bc66b2863f8D58C8185b1ed6147895632812';
        let currentChartType = 'waterDepth';
        let chartInstance = null;
        let historicalData = [];
        let fieldConfigs = [];

        // UI Manipulation Helper
        const $ = (id) => document.getElementById(id);

        async function init() {
            lucide.createIcons();
            await refreshData();
        }

        async function refreshData() {
            try {
                showLoading(true);

                // 1. Fetch Store Metadata
                const [nickname, owner, sensorCount, deployedBlock, description] = await client.readContract({
                    address: FACTORY_ADDRESS,
                    abi: FACTORY_ABI,
                    functionName: 'getStoreInfo',
                    args: [currentStore]
                });

                updateMetadataUI({ nickname, owner, sensorCount, deployedBlock, description });

                // 2. Fetch Field Configs & Latest Data
                [fieldConfigs, [latestTimestamp, latestValues]] = await Promise.all([
                    client.readContract({ address: currentStore, abi: STORE_ABI, functionName: 'getAllFields' }),
                    client.readContract({ address: currentStore, abi: STORE_ABI, functionName: 'getLatestRecord', args: [UNIVERSAL_SIGNER] })
                ]);

                updateTableUI(latestTimestamp, latestValues);

                // 3. Fetch Historical Data (Events)
                await fetchHistory();

                renderChart();
                updateCurrentBlock();
            } catch (err) {
                console.error("Data Fetch Error:", err);
                alert("Failed to fetch blockchain data. Please check your connection.");
            } finally {
                showLoading(false);
            }
        }

        async function fetchHistory() {
            const currentBlock = await client.getBlockNumber();
            const fromBlock = currentBlock - 28800n; // ~24h (3s blocks)

            const events = await client.getContractEvents({
                address: currentStore,
                abi: STORE_ABI,
                eventName: 'RecordStored',
                fromBlock: fromBlock,
                args: { sensor: UNIVERSAL_SIGNER }
            });

            const wdIdx = findFieldIndex('water_depth');
            const bvIdx = findFieldIndex('battery_voltage');

            historicalData = events.map(e => ({
                t: Number(e.args.timestamp) * 1000,
                wd: wdIdx !== -1 ? Number(e.args.values[wdIdx]) / 10000 : null,
                bv: bvIdx !== -1 ? Number(e.args.values[bvIdx]) / 100 : null
            })).sort((a, b) => a.t - b.t);

            // Simple Data Smoothing (3-point moving average)
            if (historicalData.length > 3) {
                historicalData = historicalData.map((d, i, arr) => {
                    if (i < 1 || i > arr.length - 2) return d;
                    return {
                        ...d,
                        wd: (arr[i - 1].wd + d.wd + arr[i + 1].wd) / 3,
                        bv: (arr[i - 1].bv + d.bv + arr[i + 1].bv) / 3
                    };
                });
            }
        }

        function updateMetadataUI(data) {
            $('store-nickname').innerText = data.nickname;
            $('store-description').innerText = data.description;
            $('store-address-truncated').innerText = truncateAddress(currentStore);
            $('owner-address').innerText = truncateAddress(data.owner);
            $('sensor-count').innerText = data.sensorCount.toString();
            $('deployed-block-number').innerText = `#${data.deployedBlock}`;

            const expUrl = JIBCHAIN.blockExplorers.default.url;
            $('owner-link').href = `${expUrl}/address/${data.owner}`;
            $('deployed-block-link').href = `${expUrl}/block/${data.deployedBlock}`;
            $('store-address-link').onclick = () => window.open(`${expUrl}/address/${currentStore}`, '_blank');
        }

        function updateTableUI(timestamp, values) {
            const date = new Date(Number(timestamp) * 1000);
            $('last-updated-time').innerText = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            // Format: MM/dd/yyyy, h:mm:ss AM/PM
            const fullDateStr = date.toLocaleString('en-US', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: 'numeric', minute: '2-digit', second: '2-digit',
                hour12: true
            });
            $('last-updated-date').innerText = fullDateStr.split(',')[0];

            const tbody = $('data-table-body');
            tbody.innerHTML = '';

            const fieldsToDisplay = [];
            const waterDepthIdx = findFieldIndex('water_depth');
            const waterDepthCountIdx = findFieldIndex('water_depth_count');
            const batteryIdx = findFieldIndex('battery_voltage');
            const heightIdx = findFieldIndex('installation_height');

            if (batteryIdx !== -1) {
                const config = fieldConfigs[batteryIdx];
                fieldsToDisplay.push({
                    name: formatFieldName(config.name),
                    current: processValue(values[batteryIdx], config.unit),
                    min: processValue(values[batteryIdx + 1], config.unit),
                    max: processValue(values[batteryIdx + 2], config.unit)
                });
            }

            if (heightIdx !== -1) {
                const config = fieldConfigs[heightIdx];
                fieldsToDisplay.push({
                    name: formatFieldName(config.name),
                    current: processValue(values[heightIdx], config.unit),
                    min: processValue(values[heightIdx], config.unit),
                    max: processValue(values[heightIdx], config.unit)
                });
            }

            if (waterDepthIdx !== -1) {
                const config = fieldConfigs[waterDepthIdx];
                const sampleCount = waterDepthCountIdx !== -1 ? values[waterDepthCountIdx].toString() : '?';
                fieldsToDisplay.push({
                    name: `Water Depth (${sampleCount} samples)`,
                    current: processValue(values[waterDepthIdx], config.unit),
                    min: processValue(values[waterDepthIdx + 1], config.unit),
                    max: processValue(values[waterDepthIdx + 2], config.unit)
                });
            }

            fieldsToDisplay.forEach((f, idx) => {
                const row = document.createElement('tr');
                row.className = idx % 2 === 0 ? 'bg-white' : 'bg-slate-50/50';
                row.innerHTML = `
                    <td class="px-6 py-4 font-semibold text-slate-900">${f.name}</td>
                    <td class="px-6 py-4 text-blue-600 font-bold">${f.current}</td>
                    <td class="px-6 py-4 text-slate-500">${f.min}</td>
                    <td class="px-6 py-4 text-slate-500">${f.max}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderChart() {
            const ctx = $('sensorChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            if (historicalData.length === 0) {
                drawEmptyChartState();
                return;
            }

            const isWD = currentChartType === 'waterDepth';
            const color = isWD ? '#3B82F6' : '#10B981';
            const label = isWD ? 'Water Depth Over Time' : 'Battery Voltage Over Time';
            const dataKey = isWD ? 'wd' : 'bv';

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: historicalData.map(d => new Date(d.t).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })),
                    datasets: [{
                        label: label,
                        data: historicalData.map(d => d[dataKey]),
                        borderColor: color,
                        backgroundColor: color + '20',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 2,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1E293B',
                            titleFont: { size: 13 },
                            bodyFont: { size: 14, weight: 'bold' },
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: (ctx) => ` ${ctx.parsed.y.toFixed(isWD ? 4 : 3)} ${isWD ? 'm' : 'V'}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            border: { display: false },
                            grid: { color: '#f1f5f9' },
                            ticks: {
                                font: { family: 'Inter', size: 11 },
                                callback: (v) => v + (isWD ? 'm' : 'V'),
                                title: { display: true, text: isWD ? 'Water Depth (m)' : 'Voltage (V)', font: { weight: 'bold' } }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { family: 'Inter', size: 10 }, maxRotation: 0 }
                        }
                    }
                }
            });
        }

        // Processing Utils
        function processValue(value, unit) {
            const baseUnit = unit.replace(/ x\d+/, '');
            const num = Number(value);
            if (unit.includes('x10000')) return (num / 10000).toFixed(4) + ' ' + baseUnit;
            if (unit.includes('x1000')) return (num / 1000).toFixed(3) + ' ' + baseUnit;
            if (unit.includes('x100')) return (num / 100).toFixed(3) + ' ' + baseUnit;
            return value + ' ' + unit;
        }

        function formatFieldName(fieldName) {
            return fieldName
                .split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
        }

        function findFieldIndex(query) {
            return fieldConfigs.findIndex(f => f.name.toLowerCase().includes(query) && !f.name.includes('min') && !f.name.includes('max'));
        }

        function truncateAddress(addr) {
            return `${addr.slice(0, 6)}...${addr.slice(-4)}`;
        }

        async function updateCurrentBlock() {
            const block = await client.getBlockNumber();
            $('current-block').innerText = `Block: ${block}`;
        }

        function showLoading(show) {
            $('chart-loading').classList.toggle('hidden', !show);
            $('chart-parent').classList.toggle('hidden', show);
        }

        // Global Callbacks for UI
        window.switchChart = (type) => {
            currentChartType = type;
            $('btn-water-depth').className = type === 'waterDepth' ? 'px-4 py-2 rounded-lg text-sm font-semibold transition-all bg-blue-500 text-white shadow-md' : 'px-4 py-2 rounded-lg text-sm font-semibold transition-all bg-slate-100 text-slate-600 hover:bg-slate-200';
            $('btn-battery-voltage').className = type === 'batteryVoltage' ? 'px-4 py-2 rounded-lg text-sm font-semibold transition-all bg-emerald-500 text-white shadow-md' : 'px-4 py-2 rounded-lg text-sm font-semibold transition-all bg-slate-100 text-slate-600 hover:bg-slate-200';
            renderChart();
        };

        window.switchStore = async (addr) => {
            currentStore = addr;
            await refreshData();
        };

        window.toggleFields = () => {
            const container = $('table-container');
            container.classList.toggle('hidden');
        }

        window.toggleFullscreen = () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }

        function drawEmptyChartState() {
            const ctx = $('sensorChart').getContext('2d');
            ctx.font = '14px Inter';
            ctx.fillStyle = '#94a3b8';
            ctx.textAlign = 'center';
            ctx.fillText('No historical data available for this range', ctx.canvas.width / 2, ctx.canvas.height / 2);
        }

        init();
    </script>

</body>

</html>